<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicXML 转 古琴谱</title>
    <style>
        /* 复用之前的完美 CSS */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&display=swap');
        :root { --paper-color: #f4f1ea; --ink-color: #2b2b2b; }
        body { font-family: 'Noto Serif SC', "KaiTi", "楷体", serif; background-color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .control-panel { background: white; padding: 20px; border-radius: 8px; width: 100%; max-width: 900px; margin-bottom: 20px; display: flex; gap: 20px; }
        textarea { flex: 1; height: 150px; padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-size: 12px;}
        .buttons { display: flex; flex-direction: column; gap: 10px; justify-content: center;}
        button { padding: 10px 20px; background: #8b4513; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold;}
        button:hover { background: #a0522d; }

        #score-paper { background-color: var(--paper-color); width: 100%; max-width: 900px; min-height: 500px; padding: 50px; box-shadow: 0 0 20px rgba(0,0,0,0.5); display: flex; flex-wrap: wrap; align-content: flex-start; gap: 5px; }
        h2.title { width: 100%; text-align: center; margin-bottom: 40px; font-size: 36px; color: var(--ink-color); letter-spacing: 5px; }

        .guqin-note { display: flex; flex-direction: column; align-items: center; width: 55px; margin-bottom: 20px; }
        .meta-info { height: 40px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; margin-bottom: 4px; }
        .jianpu { font-size: 16px; font-weight: 900; color: #555; }
        .lyric { font-size: 14px; color: #888; margin-top: 2px; }

        .guqin-char { width: 50px; height: 55px; position: relative; display: flex; flex-direction: column; align-items: center; color: var(--ink-color); }
        .char-top { font-size: 26px; line-height: 1; height: 14px; transform: scale(1.4, 0.65); margin-bottom: -4px; z-index: 10; }
        .char-bottom { position: relative; width: 100%; height: 40px; display: flex; justify-content: center; }
        .wrapper { font-size: 40px; line-height: 1; font-weight: normal; transform: scale(1, 0.95); }
        .inner { position: absolute; font-size: 13px; font-weight: 900; }
        
        .layout-tiao .inner { top: 6px; left: 20px; }
        .layout-tiao .wrapper { margin-left: -8px; }
        .layout-gou .inner { top: 14px; left: 50%; transform: translateX(-50%); }
        .layout-gou .wrapper { margin-top: -2px; }
        
        .bar-line { width: 1px; height: 100px; background-color: #999; margin: 0 15px; align-self: center; }
    </style>
</head>
<body>

    <div class="control-panel">
        <textarea id="inputData" placeholder="在此粘贴 MusicXML 内容..."></textarea>
        <div class="buttons">
            <button onclick="loadDefault()">载入测试文件 (Test1.md)</button>
            <button onclick="generate()">生成古琴谱</button>
        </div>
    </div>

    <div id="score-paper">
        <h2 class="title" id="songTitle">古琴谱</h2>
        <div id="render-area" style="display: flex; flex-wrap: wrap; width: 100%;"></div>
    </div>

    <script>
        // 你提供的 Test1.md 的内容 (MusicXML)
        const DEFAULT_XML = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 4.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="4.0">
  <work><work-title>Prev_258.0</work-title></work>
  <part-list><score-part id="P1"><part-name>Piano</part-name></score-part></part-list>
  <part id="P1">
    <measure number="1"><note><rest measure="yes"/><duration>8</duration><staff>2</staff></note><backup><duration>8</duration></backup><note><pitch><step>B</step><alter>0</alter><octave>4</octave></pitch><duration>8</duration><type>eighth</type><stem>down</stem><staff>1</staff><voice>1</voice></note></measure>
    <measure number="2"><note><pitch><step>G</step><alter>0</alter><octave>5</octave></pitch><duration>24</duration><type>quarter</type><dot/><stem>down</stem><staff>1</staff><voice>1</voice></note><backup><duration>24</duration></backup><note><pitch><step>E</step><alter>0</alter><octave>2</octave></pitch><duration>8</duration><staff>2</staff></note><note><pitch><step>G</step><alter>0</alter><octave>3</octave></pitch><duration>8</duration><staff>2</staff></note><note><chord/><pitch><step>E</step><alter>0</alter><octave>4</octave></pitch><duration>8</duration><staff>2</staff></note><note><pitch><step>B</step><alter>0</alter><octave>3</octave></pitch><duration>8</duration><staff>2</staff></note><note><chord/><pitch><step>G</step><alter>0</alter><octave>4</octave></pitch><duration>8</duration><staff>2</staff></note><note><chord/><pitch><step>E</step><alter>0</alter><octave>4</octave></pitch><duration>8</duration><staff>2</staff></note><note><pitch><step>E</step><alter>0</alter><octave>3</octave></pitch><duration>8</duration><staff>2</staff></note><backup><duration>8</duration></backup><note><pitch><step>G</step><alter>0</alter><octave>5</octave></pitch><duration>8</duration><staff>1</staff></note><note><pitch><step>F</step><alter>0</alter><octave>5</octave></pitch><duration>8</duration><staff>1</staff></note><backup><duration>8</duration></backup><note><pitch><step>A</step><alter>0</alter><octave>3</octave></pitch><duration>8</duration><staff>2</staff></note><note><chord/><pitch><step>D</step><alter>0</alter><octave>4</octave></pitch><duration>8</duration><staff>2</staff></note><note><pitch><step>A</step><alter>0</alter><octave>4</octave></pitch><duration>8</duration><staff>2</staff></note><note><chord/><pitch><step>C</step><alter>0</alter><octave>4</octave></pitch><duration>8</duration><staff>2</staff></note><note><chord/><pitch><step>D</step><alter>0</alter><octave>4</octave></pitch><duration>8</duration><staff>2</staff></note><backup><duration>8</duration></backup><note><pitch><step>G</step><alter>0</alter><octave>5</octave></pitch><duration>8</duration><staff>1</staff></note><note><pitch><step>E</step><alter>0</alter><octave>2</octave></pitch><duration>8</duration><staff>2</staff></note><backup><duration>8</duration></backup><note><pitch><step>F</step><alter>0</alter><octave>5</octave></pitch><duration>24</duration><staff>1</staff></note><backup><duration>16</duration></backup><note><pitch><step>G</step><alter>0</alter><octave>3</octave></pitch><duration>16</duration><staff>2</staff></note><note><chord/><pitch><step>E</step><alter>0</alter><octave>4</octave></pitch><duration>16</duration><staff>2</staff></note><note><pitch><step>B</step><alter>0</alter><octave>3</octave></pitch><duration>16</duration><staff>2</staff></note><note><chord/><pitch><step>E</step><alter>0</alter><octave>4</octave></pitch><duration>16</duration><staff>2</staff></note><note><chord/><pitch><step>G</step><alter>0</alter><octave>4</octave></pitch><duration>16</duration><staff>2</staff></note><backup><duration>16</duration></backup><note><rest measure="yes"/><duration>16</duration><staff>1</staff></note><note><pitch><step>E</step><alter>0</alter><octave>5</octave></pitch><duration>16</duration><staff>1</staff></note><backup><duration>16</duration></backup><note><pitch><step>D</step><alter>0</alter><octave>2</octave></pitch><duration>8</duration><staff>2</staff></note><note><pitch><step>G</step><alter>0</alter><octave>3</octave></pitch><duration>16</duration><staff>2</staff></note><note><chord/><pitch><step>E</step><alter>0</alter><octave>4</octave></pitch><duration>16</duration><staff>2</staff></note><backup><duration>16</duration></backup><note><rest measure="yes"/><duration>8</duration><staff>1</staff></note><note><pitch><step>B</step><alter>0</alter><octave>3</octave></pitch><duration>16</duration><staff>2</staff></note><note><chord/><pitch><step>G</step><alter>0</alter><octave>4</octave></pitch><duration>16</duration><staff>2</staff></note><note><chord/><pitch><step>E</step><alter>0</alter><octave>4</octave></pitch><duration>16</duration><staff>2</staff></note><backup><duration>16</duration></backup><note><pitch><step>B</step><alter>0</alter><octave>4</octave></pitch><duration>8</duration><staff>1</staff></note></measure>
    <!-- 为了演示简洁，这里只截取了前两小节，实际你可以粘贴完整的 -->
  </part>
</score-partwise>`;

        window.onload = loadDefault;

        function loadDefault() {
            document.getElementById('inputData').value = DEFAULT_XML;
        }

        async function generate() {
            const inputVal = document.getElementById('inputData').value;
            if (!inputVal) { alert("内容为空"); return; }

            try {
                // 直接发送字符串给后端，让后端去判断是 XML 还是 JSON
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/xml' }, // 标记为 XML 或 text
                    body: inputVal
                });
                const data = await response.json();
                renderScore(data);
            } catch (err) {
                console.error(err);
                alert("生成失败，请检查后端报错");
            }
        }

        function renderScore(data) {
            const container = document.getElementById('render-area');
            const title = document.getElementById('songTitle');
            container.innerHTML = '';
            if(data.song_info?.title) title.innerText = data.song_info.title;

            data.render_queue.forEach(item => {
                if (item.type === 'bar_line') {
                    const line = document.createElement('div');
                    line.className = 'bar-line';
                    container.appendChild(line);
                    return;
                }

                if (item.type === 'guqin_char' && item.layout_mode === 'open_string') {
                    let layoutClass = '';
                    const wrapper = item.components.bottom_wrapper;
                    
                    if (wrapper === '乚') layoutClass = 'layout-tiao';
                    else if (wrapper === '勹') layoutClass = 'layout-gou';

                    // 如果是空字符（MusicXML里找不到散音的情况），我们可以渲染一个占位符或者只显示简谱
                    const topChar = item.components.top || "";
                    const innerChar = item.components.bottom_inner || "";
                    const wrapperChar = item.components.bottom_wrapper || "";

                    const noteHtml = `
                        <div class="guqin-note">
                            <div class="meta-info">
                                <span class="jianpu">${item.display_info.jianpu}</span>
                                <span class="lyric">${item.display_info.lyric}</span>
                            </div>
                            <div class="guqin-char">
                                <div class="char-top">${topChar}</div>
                                <div class="char-bottom ${layoutClass}">
                                    <span class="wrapper">${wrapperChar}</span>
                                    <span class="inner">${innerChar}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = noteHtml;
                    container.appendChild(tempDiv.firstElementChild);
                }
            });
        }
    </script>
</body>
</html>